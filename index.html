<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>äº”åéŸ³å†’éšª v3.1 - è‡ªä¸»é¸é—œç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background: #E8F5E9; font-family: 'Arial', 'Hiragino Kaku Gothic Pro', sans-serif; touch-action: manipulation; }
        
        /* é¸å–®ç•«é¢ */
        #menu-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 500; display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        .row-selector {
            display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0;
        }
        .row-btn {
            padding: 15px 25px; font-size: 20px; border: 3px solid #4CAF50; border-radius: 15px;
            background: white; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #388E3C;
        }
        .row-btn.selected { background: #4CAF50; color: white; transform: translateY(4px); box-shadow: none; }

        /* å­¸ç¿’ç•«é¢ */
        #study-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #FFFDE7; z-index: 400; display: none; flex-direction: column; align-items: center; padding: 20px;
        }
        .kana-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .kana-card { 
            width: 65px; height: 65px; background: white; border: 2px solid #FFB74D; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; font-size: 28px; cursor: pointer;
            box-shadow: 0 4px 0 #FFA000;
        }
        .kana-card:active { transform: translateY(2px); box-shadow: 0 2px 0 #FFA000; }

        /* éŠæˆ²ä»‹é¢ */
        #ui-panel { position: absolute; top: 20px; width: 100%; text-align: center; z-index: 100; display: none; pointer-events: none; }
        #listen-btn {
            pointer-events: auto; font-size: 50px; background: white; border: 5px solid #2196F3;
            border-radius: 50%; width: 100px; height: 100px; cursor: pointer; box-shadow: 0 6px 0 #1976D2;
        }
        #listen-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #1976D2; }

        .bubble {
            position: absolute; width: 90px; height: 90px;
            background: radial-gradient(circle at 30% 30%, #fff, #81D4FA);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 35px; font-weight: bold; color: #01579B; animation: float 10s linear infinite;
            box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1);
        }
        @keyframes float { 0% { transform: translateY(110vh); } 100% { transform: translateY(-20vh); } }
        
        .nav-btn { margin-top: 30px; padding: 15px 40px; font-size: 24px; background: #FF7043; color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 5px 0 #E64A19; }
        .nav-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #E64A19; }

        #version-tag { position: fixed; bottom: 5px; right: 10px; font-size: 12px; color: #ccc; }
    </style>
</head>
<body>

<div id="version-tag">v3.1</div>

<div id="menu-screen">
    <h1 style="color: #2E7D32;">ğŸ® äº”åéŸ³å¤§å†’éšª</h1>
    <p>ä½ æƒ³ç·´ç¿’å“ªå¹¾è¡Œæœ‹å‹ï¼Ÿ</p>
    <div class="row-selector">
        <div class="row-btn" onclick="toggleRow(this, 'ã‚')">ã‚ è¡Œ</div>
        <div class="row-btn" onclick="toggleRow(this, 'ã‹')">ã‹ è¡Œ</div>
        <div class="row-btn" onclick="toggleRow(this, 'ã•')">ã• è¡Œ</div>
        <div class="row-btn" onclick="toggleRow(this, 'ãŸ')">ãŸ è¡Œ</div>
        <div class="row-btn" onclick="toggleRow(this, 'ãª')">ãª è¡Œ</div>
    </div>
    <button class="nav-btn" onclick="goToStudy()">é¸å¥½äº†ï¼Œå»ç·´ç¿’ï¼</button>
</div>

<div id="study-screen">
    <h2 id="study-title" style="color: #F57C00;">é»é»çœ‹ï¼Œè¨˜ä½è²éŸ³å–”ï¼</h2>
    <div class="kana-grid" id="study-grid"></div>
    <button class="nav-btn" style="background:#4CAF50; box-shadow: 0 5px 0 #388E3C;" onclick="startChallenge()">è¨˜å¥½äº†ï¼Œé–‹å§‹æ¯”è³½ï¼</button>
    <button onclick="location.reload()" style="margin-top:20px; background:none; border:none; color:#999; text-decoration:underline;">é‡æ–°é¸è¡Œ</button>
</div>

<div id="ui-panel">
    <button id="listen-btn" onclick="speak(currentTarget)">ğŸ‘‚</button>
    <p style="font-weight: bold; color: #1565C0; margin-top:10px;">è½è²éŸ³ï¼ŒæŠ“æ³¡æ³¡ï¼</p>
    <button onclick="location.reload()" style="pointer-events:auto; position:fixed; top:15px; right:15px; padding:10px; border-radius:10px; background:white; border:1px solid #ccc;">é‡é¸</button>
</div>
<div id="game-container"></div>

<script>
    const kanaMap = {
        'ã‚': ['ã‚','ã„','ã†','ãˆ','ãŠ'],
        'ã‹': ['ã‹','ã','ã','ã‘','ã“'],
        'ã•': ['ã•','ã—','è¿·','ã›','ã'], // ä¿®æ­£ä¸€å€‹å°åœ°æ–¹
        'ã•': ['ã•','ã—','ã™','ã›','ã'],
        'ãŸ': ['ãŸ','ã¡','ã¤','ã¦','ã¨'],
        'ãª': ['ãª','ã«','ã¬','ne','ã®'], // ä¿®æ­£ï¼šã¬ã€ã­ã€ã®
        'ãª': ['ãª','ã«','ã¬','ã­','ã®']
    };
    
    let selectedRows = [];
    let activeKanaList = [];
    let currentTarget = "";
    let gameInterval;
    const synth = window.speechSynthesis;

    function toggleRow(btn, rowKey) {
        btn.classList.toggle('selected');
        if (selectedRows.includes(rowKey)) {
            selectedRows = selectedRows.filter(r => r !== rowKey);
        } else {
            selectedRows.push(rowKey);
        }
    }

    function goToStudy() {
        if (selectedRows.length === 0) {
            alert("è«‹å…ˆé¸æ“‡è¦ç·´ç¿’çš„è¡Œå–”ï¼");
            return;
        }
        activeKanaList = [];
        selectedRows.forEach(row => {
            activeKanaList = activeKanaList.concat(kanaMap[row]);
        });

        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('study-screen').style.display = 'flex';
        
        const grid = document.getElementById('study-grid');
        grid.innerHTML = '';
        activeKanaList.forEach(k => {
            const div = document.createElement('div');
            div.className = 'kana-card';
            div.innerText = k;
            div.onclick = () => speak(k);
            grid.appendChild(div);
        });
    }

    function speak(text) {
        if (!text) return;
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'ja-JP';
        utter.rate = 0.75;
        synth.speak(utter);
    }

    function startChallenge() {
        document.getElementById('study-screen').style.display = 'none';
        document.getElementById('ui-panel').style.display = 'block';
        nextRound();
        gameInterval = setInterval(createBubble, 1800);
    }

    function nextRound() {
        currentTarget = activeKanaList[Math.floor(Math.random() * activeKanaList.length)];
        setTimeout(() => speak(currentTarget), 500);
    }

    function createBubble() {
        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        // ç¢ºä¿é¡Œç›®å­—å‡ºç¾çš„æ©Ÿç‡é«˜ä¸€é»
        const isTarget = Math.random() > 0.4;
        const char = isTarget ? currentTarget : activeKanaList[Math.floor(Math.random() * activeKanaList.length)];
        
        bubble.innerText = char;
        bubble.style.left = Math.random() * 75 + 10 + "vw";
        
        bubble.onclick = function() {
            if (char === currentTarget) {
                bubble.style.background = '#A5D6A7';
                bubble.style.transform = 'scale(1.3)';
                bubble.style.transition = '0.2s';
                setTimeout(() => {
                    if(bubble.parentNode) bubble.remove();
                    nextRound();
                }, 200);
            } else {
                bubble.style.background = '#EF9A9A';
                // é»éŒ¯æŠ–å‹•ä¸€ä¸‹
                bubble.style.transform = 'translateX(5px)';
                setTimeout(()=> bubble.style.transform = 'translateX(-5px)', 50);
                speak(currentTarget); // å†æç¤ºä¸€æ¬¡æ­£ç¢ºè®€éŸ³
            }
        };
        
        document.getElementById('game-container').appendChild(bubble);
        
        // æ³¡æ³¡é£„å¤ªé«˜è‡ªå‹•æ¶ˆå¤±
        setTimeout(() => { if(bubble.parentNode) bubble.remove(); }, 11000);
    }
</script>
</body>
</html>
